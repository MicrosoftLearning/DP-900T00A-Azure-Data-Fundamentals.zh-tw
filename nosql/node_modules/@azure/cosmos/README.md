---
ms.openlocfilehash: 3e62289181d994a0e786bb53417f576ac1a3059b
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/05/2022
ms.locfileid: "138050728"
---
# <a name="azure-cosmos-db-client-library-for-javascripttypescript"></a>適用於 JavaScript/TypeScript 的 Azure Cosmos DB 用戶端程式庫

[![最新 npm 徽章](https://img.shields.io/npm/v/%40azure%2Fcosmos/latest.svg)][npm]
[![組建狀態](https://dev.azure.com/azure-sdk/public/_apis/build/status/js/js%20-%20cosmosdb%20-%20ci?branchName=main)](https://dev.azure.com/azure-sdk/public/_build/latest?definitionId=850&branchName=main)

Azure Cosmos DB 是全域散發、多模型資料庫服務，支援文件、索引鍵/值組、寬列資料行及圖形資料庫。 此套件適用於 JavaScript/Typescript 應用程式，以便與 **SQL API** 資料庫以及其中包含的 JSON 文件互動：

- 建立 Cosmos DB 資料庫並修改相關設定
- 建立和修改容器以儲存 JSON 文件的集合
- 建立、讀取、更新和刪除容器中的項目 (JSON 文件)
- 使用與 SQL 相似的語法查詢資料庫的文件

重要連結：

- [套件 (npm)][npm]
- [API 參考文件](https://docs.microsoft.com/javascript/api/@azure/cosmos/?view=azure-node-lates)
- [產品文件][cosmos_docs]

## <a name="getting-started"></a>開始使用

### <a name="prerequisites"></a>Prerequisites

#### <a name="azure-subscription-and-cosmos-db-sql-api-account"></a>Azure 訂用帳戶與 Cosmos DB SQL API 帳戶

您必須擁有 [Azure 訂用帳戶][azure_sub]和 [Cosmos DB 帳戶][cosmos_account] (SQL API) 才能使用此套件。

如果您需要 Cosmos DB SQL API 帳戶，可以使用 Azure [Cloud Shell][cloud_shell_bash] 並藉由此 Azure CLI 命令建立帳戶：

```Bash
az cosmosdb create --resource-group <resource-group-name> --name <cosmos-database-account-name>
```

或者您也可以在 [Azure 入口網站](https://portal.azure.com/#create/microsoft.documentdb)中建立帳戶

#### <a name="nodejs"></a>NodeJS

此套件會透過預先安裝 [NodeJS][npm] 的 [npm](https://nodejs.org/en/) 散發。 您應該使用 Node v10 或更新版本。

#### <a name="cors"></a>CORS

如果您需要針對瀏覽器進行開發，您必須為 Cosmos DB 帳戶設定[跨原始來源資源共用 (CORS) ](https://docs.microsoft.com/azure/cosmos-db/how-to-configure-cross-origin-resource-sharing)規則。 請遵循連結文件中的指示，為您的 Cosmos DB 建立新的 CORS 規則。

### <a name="install-this-package"></a>安裝此套件

```Bash
npm install @azure/cosmos
```

### <a name="get-account-credentials"></a>取得帳戶認證

您需要 Cosmos DB **帳戶端點** 和 **金鑰**。 您可以在 [Azure 入口網站](https://portal.azure.com/#blade/hubsextension/browseresource/resourcetype/microsoft.documentdb%2fdatabaseaccounts)中找到這些資訊，或使用下方的 [Azure CLI][azure_cli] 程式碼片段。 此程式碼片段會針對 Bash Shell 加以格式化。

```Bash
az cosmosdb show --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
az cosmosdb keys list --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
```

### <a name="create-an-instance-of-cosmosclient"></a>建立 `CosmosClient` 的執行個體

與 Cosmos DB 的互動會從 [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) 類別的執行個體開始

```js
const { CosmosClient } = require("@azure/cosmos");

const endpoint = "https://your-account.documents.azure.com";
const key = "<database account masterkey>";
const client = new CosmosClient({ endpoint, key });

async function main() {
  // The rest of the README samples are designed to be pasted into this function body
}

main().catch((error) => {
  console.error(error);
});
```

為了簡單起見，我們已將 `key` 和 `endpoint` 直接包含在程式碼中，但您可能會想使用 [dotenv](https://www.npmjs.com/package/dotenv) 等專案，從並非位於原始檔控制的文件中載入這些程式碼，或是從環境變數載入

在實際執行環境中，金鑰等秘密應該儲存在 [Azure Key Vault](https://azure.microsoft.com/services/key-vault/)

## <a name="key-concepts"></a>重要概念

當您將 [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-lates) 初始化之後，便能與 Cosmos DB 中的主要資源類型互動：

- [資料庫：](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest)一個 Cosmos DB 帳戶可以包含多個資料庫。 在建立資料庫時，您可以指定在與資料庫內文件互動時想使用的 API：SQL、MongoDB、Gremlin、Cassandra 或 Azure Table。 使用[資料庫](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest)物件來管理容器。

- [容器](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest)：容器是 JSON 文件的集合。 您可以使用[容器](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest)物件上的方法，建立 (插入)、讀取、更新和刪除容器中的項目。

- [項目](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest)：項目是儲存在容器中的 JSON 文件。 每個項目都必須包含一個 `id` 金鑰，此金鑰值可唯一識別容器內的項目。 如果您不提供 `id`，SDK 就會自動產生一個。

如需這些資源的詳細資訊，請參閱[使用 Azure Cosmos 資料庫、容器和項目][cosmos_resources]。

## <a name="examples"></a>範例

下列各節提供數個程式碼片段，內容涵蓋一些最常見的 Cosmos DB 工作，包括：

- [建立資料庫](#create-a-database)
- [建立容器](#create-a-container)
- [插入項目](#insert-items)
- [查詢文件](#query-the-database)
- [讀取項目](#read-an-item)
- [刪除項目](#delete-an-data)

### <a name="create-a-database"></a>建立資料庫

驗證 [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) 之後，您便能使用帳戶中的任何資源。 下列程式碼片段會建立 SQL API 資料庫。

```js
const { database } = await client.databases.createIfNotExists({ id: "Test Database" });
console.log(database.id);
```

### <a name="create-a-container"></a>建立容器

此範例會建立使用預設設定的容器

```js
const { container } = await database.containers.createIfNotExists({ id: "Test Database" });
console.log(container.id);
```

### <a name="insert-items"></a>插入項目

若要將項目插入容器中，請將包含資料的物件傳遞至 [Items.upsert](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#upsert-t--requestoptions-)。 Cosmos DB 服務要求每個項目都有 `id` 金鑰。 如果您不提供 `id`，SDK 就會自動產生一個。

此範例會將數個項目插入容器中

```js
const cities = [
  { id: "1", name: "Olympia", state: "WA", isCapitol: true },
  { id: "2", name: "Redmond", state: "WA", isCapitol: false },
  { id: "3", name: "Chicago", state: "IL", isCapitol: false }
];
for (const city of cities) {
  container.items.create(city);
}
```

### <a name="read-an-item"></a>讀取項目

若要從容器讀取單一項目，請使用 [Item.read](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#read-requestoptions-)。 相較於使用 SQL，使用 `id` 查詢是成本較低的作業。

```js
await container.item("1").read();
```

### <a name="delete-an-item"></a>刪除項目

若要從容器中刪除項目，請使用 [Item.delete](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#delete-requestoptions-)。

```js
// Delete the first item returned by the query above
await container.item("1").delete();
```

### <a name="query-the-database"></a>查詢資料庫

Cosmos DB SQL API 資料庫支援使用與 SQL 相似的語法，以 [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-) 查詢容器中的項目：

```js
const { resources } = await container.items
  .query("SELECT * from c WHERE c.isCapitol = true")
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

將包含參數及相關值的物件傳遞至 [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-)，以執行參數化查詢：

```js
const { resources } = await container.items
  .query({
    query: "SELECT * from c WHERE c.isCapitol = @isCapitol",
    parameters: [{ name: "@isCapitol", value: true }]
  })
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

如需使用 SQL API 查詢 Cosmos DB 資料庫的詳細資訊，請參閱[使用 SQL 查詢進行 Azure Cosmos DB 資料查詢][cosmos_sql_queries]。

## <a name="troubleshooting"></a>疑難排解

### <a name="general"></a>一般

當您與服務所傳回的 Cosmos DB 錯誤互動時，其會對應至 REST API 要求所傳回的相同 HTTP 狀態碼：

[Azure Cosmos DB 的 HTTP 狀態碼][cosmos_http_status_codes]

#### <a name="conflicts"></a>衝突

例如，如果您嘗試使用已經在 Cosmos DB 資料庫中使用的 `id` 來建立項目，則會傳回 `409` 錯誤，指出衝突所在。 下列程式碼片段會藉由攔截例外狀況並顯示錯誤的其他相關資訊，來適當地處理錯誤。

```js
try {
  await containers.items.create({ id: "existing-item-id" });
} catch (error) {
  if (error.code === 409) {
    console.log("There was a conflict with an existing item");
  }
}
```

### <a name="transpiling"></a>轉譯

Azure SDK 是專為支援 ES5 JavaScript 語法和 [LTS 版本的 Node.js](https://nodejs.org/about/releases/) 而設計。 如果您需要獲得舊版 JavaScript 執行階段的支援 (例如 Internet Explorer 或 Node 6)，您必須在組建程序中轉譯 SDK 程式碼。

### <a name="handle-transient-errors-with-retries"></a>透過重試來處理暫時性錯誤

在使用 Cosmos DB 時，您可能會遇到由於服務強制執行[速率限制][cosmos_request_units]或其他暫時性問題 (例如網路中斷) 而導致的暫時性失敗。 如需如何處理這些失敗類型的相關資訊，請參閱《雲端設計模式》指南中的[重試模式][azure_pattern_retry]，以及相關的[斷路器模式][azure_pattern_circuit_breaker]。

## <a name="next-steps"></a>下一步

### <a name="more-sample-code"></a>更多的程式碼範例

SDK 的 GitHub 存放庫中有[數個範例][cosmos_samples]可供您參考。 這些範例會提供在使用 Cosmos DB 時所經常遇到其他案例的程式碼範例：

- 資料庫作業
- 容器作業
- 項目操作
- 設定索引
- 讀取容器變更摘要
- 預存程序
- 變更資料庫/容器輸送量設定
- 多重區域寫入作業

### <a name="additional-documentation"></a>其他文件

如需 Cosmos DB 服務的更多詳細文件，請參閱 docs.microsoft.com 上的 [Azure Cosmos DB 文件][cosmos_docs]。

## <a name="useful-links"></a>實用連結

- [歡迎使用 Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/community)
- [快速入門](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-get-started)
- [教學課程](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-application)
- [範例](https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples)
- [Azure Cosmos DB 服務的資源模型簡介](https://docs.microsoft.com/azure/cosmos-db/sql-api-resources)
- [Azure Cosmos DB 服務的 SQL API 簡介](https://docs.microsoft.com/azure/cosmos-db/sql-api-sql-query)
- [資料分割](https://docs.microsoft.com/azure/cosmos-db/sql-api-partition-data)
- [API 文件](https://docs.microsoft.com/javascript/api/%40azure/cosmos/?view=azure-node-latest)

## <a name="contributing"></a>參與

如果您希望向此程式庫投稿，請參閱[投稿指南](https://github.com/Azure/azure-sdk-for-js/blob/main/CONTRIBUTING.md)，深入瞭解如何組建與測試程式碼。

![曝光數](https://azure-sdk-impressions.azurewebsites.net/api/impressions/azure-sdk-for-js%2Fsdk%2Fcosmosdb%2Fcosmos%2FREADME.png)

<!-- LINKS -->

[azure_cli]: https://docs.microsoft.com/cli/azure
[azure_pattern_circuit_breaker]: https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker
[azure_pattern_retry]: https://docs.microsoft.com/azure/architecture/patterns/retry
[azure_portal]: https://portal.azure.com
[azure_sub]: https://azure.microsoft.com/free/
[cloud_shell]: https://docs.microsoft.com/azure/cloud-shell/overview
[cloud_shell_bash]: https://shell.azure.com/bash
[cosmos_account_create]: https://docs.microsoft.com/azure/cosmos-db/how-to-manage-database-account
[cosmos_account]: https://docs.microsoft.com/azure/cosmos-db/account-overview
[cosmos_container]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-containers
[cosmos_database]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-databases
[cosmos_docs]: https://docs.microsoft.com/azure/cosmos-db/
[cosmos_http_status_codes]: https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb
[cosmos_item]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-items
[cosmos_request_units]: https://docs.microsoft.com/azure/cosmos-db/request-units
[cosmos_resources]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items
[cosmos_samples]: https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples
[cosmos_sql_queries]: https://docs.microsoft.com/azure/cosmos-db/how-to-sql-query
[cosmos_ttl]: https://docs.microsoft.com/azure/cosmos-db/time-to-live
[npm]: https://www.npmjs.com/package/@azure/cosmos
