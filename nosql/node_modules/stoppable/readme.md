---
ms.openlocfilehash: 03ad292b1fceecb8974f1d8753cb47723344dbf3
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/05/2022
ms.locfileid: "138050752"
---
# <a name="stoppable"></a>Stoppable

[![組建狀態](https://travis-ci.org/hunterloftis/stoppable.svg?branch=master)](https://travis-ci.org/hunterloftis/stoppable)

> 節點 `server.close()` 是您[預期其預設運作方式](https://github.com/nodejs/node/issues/2642)。

## <a name="summary"></a>總結

```js
const server = stoppable(http.createServer(handler))
server.stop()
```

Stoppable 停止接受新的連線，並關閉現有的閒置連線 (包括保持運作)，而不會終止正在執行的要求。

## <a name="requirements"></a>規格需求

- Node.js v6+

Node.js v4.x 為 *非正式* 支援。

## <a name="installation"></a>安裝

```bash
yarn add stoppable
```

(或使用 npm)

## <a name="usage"></a>使用方式

**建構函式**

```js
stoppable(server, grace)
```

使用 `stop` 方法裝飾伺服器執行個體。
退回伺服器執行個體，因此可以鏈結，也可以作為獨立陳述式執行。

- 伺服器：任何 HTTP 或 HTTPS 伺服器執行個體
- 寬限：強制關閉連線前所須等待的毫秒數

`grace` 預設為 Infinity (不會強制關閉)。
如果您想要立即終止所有通訊端，可以使用 0 寬限。

**stop()**

```js
server.stop(callback)
```

關閉伺服器。

- 回撥：傳遞至現有的 `server.close` 函式以自動註冊「關閉」事件。
第一個引數是錯誤，而第二個引數是布林值，指出其是否正常停止。

## <a name="design-decisions"></a>設計決策

- Monkey patching 在一般情況下表現很糟糕，但在此案例中是最佳 API。 我們將其命名為「裝飾」。
- `grace` 可以在 `stop` 上指定，但最好能比對現有的 `server.close` API。
- 我們應慎重地對待用戶端，因此我們不只是終結通訊端，還會先傳送 `FIN` 封包。
- 此問題的任何解決方案都需要紀錄於每個連線和要求/回應中。
我們正在對這些「最忙碌」程式碼路徑執行最少工作，並盡可能延遲實際 `stop` 方法。

## <a name="performance"></a>效能

如果沒有記錄連線、中斷連線、要求和回應，便無法提供這項功能。
不過，Stoppable 致力於在最忙碌程式碼路徑中執行最少工作，並使用最佳資料結構。

我有興趣查看真實世界的效能基準；程式庫中包含的簡單回送 artillery 基準，顯示使用可停止伺服器所產生的額外負荷微乎其微：

### <a name="without-stoppable"></a>不使用 Stoppable

```plain
  Scenarios launched:  10000
  Scenarios completed: 10000
  Requests completed:  10000
  RPS sent: 939.85
  Request latency:
    min: 0.5
    max: 51.3
    median: 2.1
    p95: 3.7
    p99: 15.3
  Scenario duration:
    min: 1
    max: 60.7
    median: 3.6
    p95: 7.6
    p99: 19
  Scenario counts:
    0: 10000 (100%)
  Codes:
    200: 10000
```

### <a name="with-stoppable"></a>使用 Stoppable

```plain
  Scenarios launched:  10000
  Scenarios completed: 10000
  Requests completed:  10000
  RPS sent: 940.73
  Request latency:
    min: 0.5
    max: 43.4
    median: 2.1
    p95: 3.8
    p99: 15.5
  Scenario duration:
    min: 1.1
    max: 57
    median: 3.7
    p95: 8
    p99: 19.4
  Scenario counts:
    0: 10000 (100%)
  Codes:
    200: 10000
```

## <a name="license"></a>授權

MIT